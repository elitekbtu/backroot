<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkingHead Test - V2V Integration</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .avatar-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .avatar-container {
            flex: 1;
            height: 400px;
            background: #2a2a2a;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .controls-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select, .control-group button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #404040;
            color: white;
            margin-bottom: 10px;
        }
        
        .control-group button {
            background: #007AFF;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .control-group button:hover {
            background: #0056CC;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
        }
        
        .button-row button {
            flex: 1;
        }
        
        .status {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .status h3 {
            margin-top: 0;
            color: #007AFF;
        }
        
        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info { color: #007AFF; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.error { color: #F44336; }
        .log-entry.warning { color: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ TalkingHead V2V Integration Test</h1>
            <p>Test the 3D avatar with lip-sync functionality</p>
        </div>
        
        <div class="avatar-section">
            <div class="avatar-container">
                <canvas id="avatar-canvas"></canvas>
                <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #007AFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div>Loading TalkingHead...</div>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <label>Avatar Type:</label>
                    <select id="avatar-select">
                        <option value="default">Default</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="custom">Custom URL</option>
                    </select>
                    
                    <input type="text" id="custom-avatar-url" placeholder="Custom avatar URL (.glb)" style="display: none;">
                </div>
                
                <div class="control-group">
                    <label>Text to Speak:</label>
                    <textarea id="speech-text" rows="3" placeholder="Enter text for the avatar to speak...">Hello! This is a test of the TalkingHead integration with V2V solution.</textarea>
                </div>
                
                <div class="control-group">
                    <label>Lip-Sync Data (JSON):</label>
                    <textarea id="lip-sync-data" rows="4" placeholder="Paste lip-sync data from backend...">{"type": "visemes", "visemes": ["H", "E", "L", "O"], "timing": [{"phoneme": "H", "start_time": 0, "duration": 0.1}, {"phoneme": "E", "start_time": 0.1, "duration": 0.15}, {"phoneme": "L", "start_time": 0.25, "duration": 0.1}, {"phoneme": "O", "start_time": 0.35, "duration": 0.15}], "duration": 0.5, "language": "en"}</textarea>
                </div>
                
                <div class="button-row">
                    <button onclick="speakText()">üó£Ô∏è Speak Text</button>
                    <button onclick="speakWithLipSync()">üé≠ Speak with Lip-Sync</button>
                </div>
                
                <div class="button-row">
                    <button onclick="testLipSync()">üß™ Test Lip-Sync</button>
                    <button onclick="resetAvatar()">üîÑ Reset Avatar</button>
                </div>
                
                <div class="button-row">
                    <button onclick="changeMood('happy')">üòä Happy</button>
                    <button onclick="changeMood('sad')">üò¢ Sad</button>
                    <button onclick="changeMood('angry')">üò† Angry</button>
                    <button onclick="changeMood('surprised')">üò≤ Surprised</button>
                </div>
            </div>
        </div>
        
        <div class="status">
            <h3>üìä Status</h3>
            <div id="status-text">Initializing...</div>
        </div>
        
        <div class="log">
            <h3>üìù Activity Log</h3>
            <div id="log-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@main/modules/TalkingHead.js"></script>
    <script>
        let head;
        let isAvatarReady = false;
        let currentAvatar = 'default';
        
        // Avatar URLs
        const avatarUrls = {
            'default': 'https://models.readyplayer.me/64f7c0c4c4c4c4c4c4c4c4c4.glb',
            'female': 'https://models.readyplayer.me/64f7c0c4c4c4c4c4c4c4c4c4.glb',
            'male': 'https://models.readyplayer.me/64f7c0c4c4c4c4c4c4c4c4c4.glb',
            'custom': ''
        };
        
        // Logging function
        function log(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Update status
        function updateStatus(message) {
            document.getElementById('status-text').textContent = message;
            log(message, 'info');
        }
        
        // Initialize TalkingHead
        async function initTalkingHead() {
            try {
                log('Initializing TalkingHead...', 'info');
                const container = document.getElementById('avatar-canvas');
                
                head = new TalkingHead(container, {
                    avatarUrl: avatarUrls.default,
                    cameraDistance: 2.5,
                    cameraHeight: 1.6,
                    cameraAngle: 15,
                    backgroundColor: 0x1a1a1a,
                    showSubtitles: true,
                    subtitlesColor: 0xffffff,
                    subtitlesSize: 24,
                    subtitlesY: -1.5,
                    lipsyncLang: 'en',
                    mood: 'happy'
                });
                
                await loadAvatar('default');
                log('TalkingHead initialized successfully', 'success');
                
            } catch (error) {
                log(`Error initializing TalkingHead: ${error.message}`, 'error');
                updateStatus(`Error: ${error.message}`);
            }
        }
        
        // Load avatar
        async function loadAvatar(avatarType) {
            try {
                updateStatus(`Loading ${avatarType} avatar...`);
                
                let avatarUrl = avatarUrls[avatarType];
                if (avatarType === 'custom') {
                    avatarUrl = document.getElementById('custom-avatar-url').value || avatarUrls.default;
                }
                
                await head.showAvatar({
                    avatarUrl: avatarUrl,
                    lipsyncLang: 'en'
                });
                
                currentAvatar = avatarType;
                isAvatarReady = true;
                
                document.getElementById('loading').style.display = 'none';
                updateStatus('Avatar Ready');
                log(`Avatar loaded: ${avatarType}`, 'success');
                
            } catch (error) {
                log(`Error loading avatar: ${error.message}`, 'error');
                updateStatus(`Error loading avatar: ${error.message}`);
            }
        }
        
        // Handle avatar type change
        document.getElementById('avatar-select').addEventListener('change', function(e) {
            const avatarType = e.target.value;
            if (avatarType === 'custom') {
                document.getElementById('custom-avatar-url').style.display = 'block';
            } else {
                document.getElementById('custom-avatar-url').style.display = 'none';
                if (head && isAvatarReady) {
                    loadAvatar(avatarType);
                }
            }
        });
        
        // Speak text function
        function speakText() {
            if (!isAvatarReady || !head) {
                log('Avatar not ready yet', 'warning');
                return;
            }
            
            const text = document.getElementById('speech-text').value;
            if (!text.trim()) {
                log('Please enter text to speak', 'warning');
                return;
            }
            
            log(`Speaking text: "${text}"`, 'info');
            head.speakText(text, {
                voice: 'alloy',
                onStart: () => {
                    updateStatus('Speaking...');
                    log('Speech started', 'info');
                },
                onEnd: () => {
                    updateStatus('Avatar Ready');
                    log('Speech ended', 'success');
                }
            });
        }
        
        // Speak with custom lip-sync
        function speakWithLipSync() {
            if (!isAvatarReady || !head) {
                log('Avatar not ready yet', 'warning');
                return;
            }
            
            const lipSyncDataText = document.getElementById('lip-sync-data').value;
            if (!lipSyncDataText.trim()) {
                log('Please enter lip-sync data', 'warning');
                return;
            }
            
            try {
                const lipSyncData = JSON.parse(lipSyncDataText);
                log(`Using lip-sync data: ${lipSyncData.type}`, 'info');
                
                if (lipSyncData.type === 'visemes' && lipSyncData.timing) {
                    const visemeData = lipSyncData.timing.map(t => ({
                        viseme: t.phoneme,
                        time: t.start_time * 1000,
                        duration: t.duration * 1000
                    }));
                    
                    head.speakVisemes(visemeData, {
                        onStart: () => {
                            updateStatus('Speaking with custom lip-sync...');
                            log('Custom lip-sync started', 'info');
                        },
                        onEnd: () => {
                            updateStatus('Avatar Ready');
                            log('Custom lip-sync ended', 'success');
                        }
                    });
                } else {
                    log('Invalid lip-sync data format', 'error');
                }
                
            } catch (error) {
                log(`Error parsing lip-sync data: ${error.message}`, 'error');
            }
        }
        
        // Test lip-sync function
        function testLipSync() {
            if (!isAvatarReady || !head) {
                log('Avatar not ready yet', 'warning');
                return;
            }
            
            const testText = "Hello! This is a test of the lip sync functionality.";
            log(`Testing lip-sync with: "${testText}"`, 'info');
            
            head.speakText(testText, {
                voice: 'alloy',
                onStart: () => {
                    updateStatus('Testing lip-sync...');
                    log('Lip-sync test started', 'info');
                },
                onEnd: () => {
                    updateStatus('Avatar Ready');
                    log('Lip-sync test completed', 'success');
                }
            });
        }
        
        // Reset avatar
        function resetAvatar() {
            if (head) {
                head.resetAvatar();
                updateStatus('Avatar Reset');
                log('Avatar reset', 'info');
            }
        }
        
        // Change mood
        function changeMood(mood) {
            if (head && isAvatarReady) {
                try {
                    head.setMood(mood);
                    updateStatus(`Mood changed to: ${mood}`);
                    log(`Mood changed to: ${mood}`, 'success');
                } catch (error) {
                    log(`Error changing mood: ${error.message}`, 'error');
                }
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', initTalkingHead);
        
        // Handle errors
        window.addEventListener('error', function(event) {
            log(`Global error: ${event.error}`, 'error');
        });
        
        // Add some sample lip-sync data
        document.getElementById('lip-sync-data').addEventListener('focus', function() {
            if (!this.value.trim()) {
                this.value = JSON.stringify({
                    "type": "visemes",
                    "visemes": ["H", "E", "L", "L", "O"],
                    "timing": [
                        {"phoneme": "H", "start_time": 0, "duration": 0.1},
                        {"phoneme": "E", "start_time": 0.1, "duration": 0.15},
                        {"phoneme": "L", "start_time": 0.25, "duration": 0.1},
                        {"phoneme": "L", "start_time": 0.35, "duration": 0.1},
                        {"phoneme": "O", "start_time": 0.45, "duration": 0.15}
                    ],
                    "duration": 0.6,
                    "language": "en"
                }, null, 2);
            }
        });
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
